name: Deploy to Salesforce

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'Deploy all metadata (ignore delta)'
        required: false
        type: boolean
        default: false
      skip_tests:
        description: 'Skip tests (dev only)'
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # ---------------------------------------------------------
      # 1ï¸âƒ£ Checkout repository
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2ï¸âƒ£ Install Salesforce CLI and Delta Plugin
      # ---------------------------------------------------------
      - name: Install Salesforce CLI and Delta Plugin
        run: |
          echo "ğŸ“¦ Installing Salesforce CLI..."
          npm install --global @salesforce/cli
          
          echo "ğŸ“¦ Installing sfdx-git-delta plugin..."
          echo "y" | sf plugins install sfdx-git-delta
          
          echo "âœ… Installed versions:"
          sf --version
          sf plugins --core

      # ---------------------------------------------------------
      # 3ï¸âƒ£ Authenticate to Salesforce
      # ---------------------------------------------------------
      - name: Authenticate to Salesforce
        run: |
          echo "ğŸ” Authenticating to Salesforce..."
          echo "${{ secrets.SALESFORCE_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias deployment-org --set-default
          rm -f authfile.txt
          echo "âœ… Authentication successful"

      # ---------------------------------------------------------
      # 4ï¸âƒ£ Generate Delta Package
      # ---------------------------------------------------------
      - name: Generate delta package
        id: generate_delta
        run: |
          # Check if this is first commit or full deploy requested
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ] || [ "${{ inputs.deploy_all }}" == "true" ]; then
            echo "ğŸ“¦ First commit or full deploy requested"
            echo "deploy_type=full" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            if [ "${{ inputs.deploy_all }}" == "true" ]; then
              echo "ğŸ”„ Manual full deployment triggered"
            else
              echo "ğŸ†• First commit on branch - deploying all metadata"
            fi
          else
            echo "ğŸ” Generating delta package for changes between:"
            echo "  From: ${{ github.event.before }}"
            echo "  To:   ${{ github.sha }}"
            
            # Generate delta package
            sf sgd source delta \
              --to "HEAD" \
              --from "${{ github.event.before }}" \
              --output delta-package \
              --generate-delta \
              --source force-app \
              --ignore .forceignore
            
            # Check if package.xml exists and has components
            if [ -f "delta-package/package/package.xml" ]; then
              # Count members in package.xml
              MEMBER_COUNT=$(grep -c "<members>" delta-package/package/package.xml || echo "0")
              
              if [ "$MEMBER_COUNT" -gt 0 ]; then
                echo "âœ… Delta package generated with $MEMBER_COUNT component(s)"
                echo "deploy_type=delta" >> $GITHUB_OUTPUT
                echo "has_changes=true" >> $GITHUB_OUTPUT
                
                echo ""
                echo "ğŸ“‹ Components to deploy:"
                grep -o "<members>.*</members>" delta-package/package/package.xml | sed 's/<members>//g' | sed 's/<\/members>//g' | sort
                
                echo ""
                echo "ğŸ“Š Component types:"
                grep -o "<n>.*</n>" delta-package/package/package.xml | sed 's/<n>//g' | sed 's/<\/name>//g' | sort | uniq -c
              else
                echo "â„¹ï¸ No Salesforce metadata changes detected"
                echo "has_changes=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "â„¹ï¸ No delta package generated - no Salesforce changes"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      # ---------------------------------------------------------
      # 5ï¸âƒ£ Display Deployment Plan
      # ---------------------------------------------------------
      - name: Display deployment plan
        if: steps.generate_delta.outputs.has_changes == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸš€ DEPLOYMENT PLAN"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Deployment Type: ${{ steps.generate_delta.outputs.deploy_type }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Skip Tests: ${{ inputs.skip_tests }}"
          echo ""
          
          if [ "${{ steps.generate_delta.outputs.deploy_type }}" == "delta" ]; then
            echo "ğŸ“¦ Delta Package Contents:"
            cat delta-package/package/package.xml
          else
            echo "ğŸ“¦ Deploying full source from: force-app/"
          fi
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ---------------------------------------------------------
      # 6ï¸âƒ£ Validate Deployment (Check Only)
      # ---------------------------------------------------------
      - name: Validate deployment
        if: steps.generate_delta.outputs.has_changes == 'true' && github.ref_name == 'main'
        run: |
          echo "ğŸ” Validating deployment to production (check-only)..."
          
          # Determine test level
          if [ "${{ inputs.skip_tests }}" == "true" ]; then
            TEST_LEVEL="NoTestRun"
            echo "âš ï¸ Skipping tests (not recommended for production!)"
          else
            TEST_LEVEL="RunLocalTests"
          fi
          
          # Build validation command
          if [ "${{ steps.generate_delta.outputs.deploy_type }}" == "delta" ]; then
            sf project deploy start \
              --manifest delta-package/package/package.xml \
              --target-org deployment-org \
              --dry-run \
              --test-level $TEST_LEVEL \
              --wait 30 \
              --verbose
          else
            sf project deploy start \
              --source-dir force-app \
              --target-org deployment-org \
              --dry-run \
              --test-level $TEST_LEVEL \
              --wait 30 \
              --verbose
          fi
          
          echo "âœ… Validation successful!"

      # ---------------------------------------------------------
      # 7ï¸âƒ£ Deploy to Salesforce
      # ---------------------------------------------------------
      - name: Deploy to Salesforce
        if: steps.generate_delta.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ Starting deployment..."
          
          # Determine test level based on branch and input
          if [ "${{ inputs.skip_tests }}" == "true" ]; then
            TEST_LEVEL="NoTestRun"
            echo "âš ï¸ WARNING: Deploying without running tests!"
          elif [ "${{ github.ref_name }}" == "main" ]; then
            TEST_LEVEL="RunLocalTests"
            echo "ğŸ§ª Running all local tests (production deployment)"
          else
            TEST_LEVEL="RunLocalTests"
            echo "ğŸ§ª Running local tests"
          fi
          
          # Deploy based on type
          if [ "${{ steps.generate_delta.outputs.deploy_type }}" == "delta" ]; then
            echo "ğŸ“¦ Deploying delta package..."
            
            sf project deploy start \
              --manifest delta-package/package/package.xml \
              --target-org deployment-org \
              --test-level $TEST_LEVEL \
              --wait 30 \
              --verbose
          else
            echo "ğŸ“¦ Deploying all metadata..."
            
            sf project deploy start \
              --source-dir force-app \
              --target-org deployment-org \
              --test-level $TEST_LEVEL \
              --wait 30 \
              --verbose
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… DEPLOYMENT SUCCESSFUL!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Type: ${{ steps.generate_delta.outputs.deploy_type }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ---------------------------------------------------------
      # 8ï¸âƒ£ Handle Deployment Failures
      # ---------------------------------------------------------
      - name: Handle deployment failure
        if: failure() && steps.generate_delta.outputs.has_changes == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ DEPLOYMENT FAILED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ” Common Issues & Solutions:"
          echo ""
          echo "1. âŒ Test Failures"
          echo "   â†’ Check test results above"
          echo "   â†’ Fix failing tests in your org"
          echo "   â†’ Ensure test coverage is >75%"
          echo ""
          echo "2. âŒ Layout/Profile Errors"
          echo "   â†’ Add problematic layouts to .forceignore"
          echo "   â†’ Example: **/layouts/Case-*.layout-meta.xml"
          echo ""
          echo "3. âŒ Missing Dependencies"
          echo "   â†’ Deploy required fields/objects first"
          echo "   â†’ Check field references in validation rules"
          echo ""
          echo "4. âŒ Invalid Field References"
          echo "   â†’ Verify field API names are correct"
          echo "   â†’ Check if fields exist in target org"
          echo ""
          echo "5. âŒ Permission Issues"
          echo "   â†’ Check profile/permission set access"
          echo "   â†’ Ensure deployment user has admin access"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“¦ Delta package saved as artifact for debugging"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ---------------------------------------------------------
      # 9ï¸âƒ£ Upload Delta Package Artifact
      # ---------------------------------------------------------
      - name: Upload delta package
        if: always() && steps.generate_delta.outputs.deploy_type == 'delta'
        uses: actions/upload-artifact@v4
        with:
          name: delta-package-${{ github.run_number }}
          path: delta-package/
          retention-days: 7

      # ---------------------------------------------------------
      # ğŸ”Ÿ No Changes Message
      # ---------------------------------------------------------
      - name: No changes to deploy
        if: steps.generate_delta.outputs.has_changes == 'false'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "â„¹ï¸  NO DEPLOYMENT NEEDED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "No Salesforce metadata changes detected in this commit."
          echo ""
          echo "Changed files were either:"
          echo "  â€¢ Non-Salesforce files (README, docs, etc.)"
          echo "  â€¢ Excluded by .forceignore"
          echo "  â€¢ Not in force-app/ directory"
          echo ""
          echo "This is normal and not an error! âœ…"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # ---------------------------------------------------------
      # 1ï¸âƒ£1ï¸âƒ£ Post Deployment Summary
      # ---------------------------------------------------------
      - name: Deployment summary
        if: always() && steps.generate_delta.outputs.has_changes == 'true'
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Status: $(if [ $? -eq 0 ]; then echo 'âœ… Success'; else echo 'âŒ Failed'; fi)"
          echo "Branch: ${{ github.ref_name }}"
          echo "Type: ${{ steps.generate_delta.outputs.deploy_type }}"
          echo "Commit: ${{ github.sha }}"
          echo "Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
