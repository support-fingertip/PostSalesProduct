name: Deploy to Salesforce

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      # ---------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # ---------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------
      # 2Ô∏è‚É£ Install Salesforce CLI
      # ---------------------------------------------------------
      - name: Install Salesforce CLI
        run: |
          npm install --global @salesforce/cli
          sf --version

      # ---------------------------------------------------------
      # 3Ô∏è‚É£ Authenticate to Salesforce
      # ---------------------------------------------------------
      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SALESFORCE_AUTH_URL }}" > authfile.txt
          sf org login sfdx-url --sfdx-url-file authfile.txt --alias deployment-org --set-default
          rm -f authfile.txt

      # ---------------------------------------------------------
      # 4Ô∏è‚É£ Check if any Salesforce metadata changed
      # ---------------------------------------------------------
      - name: Check for Salesforce changes
        id: check_changes
        run: |
          # For first commit on branch
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "First commit on branch - checking all files"
            CHANGED=$(git diff-tree --no-commit-id --name-only -r ${{ github.sha }} | grep '^force-app/' || true)
          else
            echo "Checking changes between ${{ github.event.before }} and ${{ github.sha }}"
            CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^force-app/' || true)
          fi
          
          echo "Changed files:"
          echo "$CHANGED"
          
          if [ -z "$CHANGED" ]; then
            echo "‚ùå No Salesforce metadata changes found"
            echo "deploy=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Salesforce metadata changes detected"
            echo "$CHANGED" > changed-files.txt
            echo "deploy=true" >> $GITHUB_OUTPUT
          fi

      # ---------------------------------------------------------
      # 5Ô∏è‚É£ Deploy to Salesforce
      # ---------------------------------------------------------
      - name: Deploy to Salesforce
        if: steps.check_changes.outputs.deploy == 'true'
        run: |
          echo "üöÄ Starting deployment..."
          
          sf project deploy start \
            --source-dir force-app \
            --target-org deployment-org \
            --wait 30 \
            --test-level RunLocalTests \
            --verbose
          
          echo "‚úÖ Deployment completed successfully!"

      # ---------------------------------------------------------
      # 6Ô∏è‚É£ Skip deployment message
      # ---------------------------------------------------------
      - name: No changes to deploy
        if: steps.check_changes.outputs.deploy == 'false'
        run: |
          echo "‚ÑπÔ∏è No Salesforce metadata changes detected. Skipping deployment."
          echo "Only non-Salesforce files were changed in this commit."
